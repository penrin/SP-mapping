SP-mapping
==========

Spherical picture mapping.




Requirments
-----------
* python3
* numpy
* scipy
* opencv-python

Equipment
---------
* Multi-Projector
	- 仮想的に単一の統合モニタとして扱えること。
	- 例えば，Matrox TripleHead2Go や NVIDIA MOSAIC などのアプリケーションを利用する。
* RICOH THETA S
	- プロジェクタ投影点位置の測定に利用する。
	- API 利用のため無線 LAN 接続をしておく。
	- API v2.1 に対応するファームウェア v01.62 以降。
	- THETA V や Z1 でも動作するかも。




Making mapping-table
--------------------

### 1. multi-projector setting
* 複数のプロジェクタが，仮想敵に単一モニタとして統合されているとする。各プロジェクタがそれぞれ統合モニタ上のどの区画に対応しているか，プロジェクタ台数分の数の png ファイルでそれぞれ表現する。
* png 画像の仕様：
	- アスペクト比は，統合モニタ全体のサイズと等しくする。
	- プロジェクタの区画は，緑レイヤーに0以外の画素値の長方形領域で表現する。
	- それ以外の画素値は0にする。
	- ファイル名は`projector_#.png`とする。# にはプロジェクタの番号が入る。番号は1からナンバリングする。この番号をプロジェクタIDと呼ぶことにする。
* 各 png ファイルのアスペクト比は等しいこと。
* 区画はオーバーラップできない。


### 2. screen setting

#### 2.1. 投影エリア設定
* 各プロジェクタが担当する投影領域に関して，プロジェクタ台数分の png ファイルで設定する。
* png 画像の仕様：
	- 正距円筒座標形式（測定に使う全天球カメラと同じ解像度が望ましい）
	- 緑レイヤー：投影領域。正距円筒図法画像上に0以上の画素値の長方形領域で表す。真上や真下をまたがる領域は設定できない。左右の境界をまたがる領域は設定できる。
	- ~~青レイヤー：他のプロジェクタとのオーバラップ領域。正距円筒図法画像上で長方形で表す。~~
	- 赤レイヤー：マスク領域。投影領域のうち，プロジェクタ投影点測定時に測定データを無効にする領域。画素値を0以上にすると，その点の計測データは無効になり，周囲のデータから推定される。カメラ三脚の影など，投影領域のうち事前に測定誤差になる箇所を塗りつぶす。
	- ファイル名は`screen_#.png`とする。# には対応するプロジェクタIDが入る。
* png ファイルはプロジェクタの台数と等しいこと。

#### 2.2. オーバーラップ設定
* 複数台のプロジェクタをつなぎ合わせて表示するとき，左右の境界を目立たなくするため，画像を重ねて表示して明るさをクロスオーバーさせる。
* オーバーラップさせる幅のほかに，プロジェクタの階調特性の情報が必要である。
* 必要な情報は`screen_overlap.json`ファイルにより設定する。
	* `screen_overlap.json `を作成しなければ，オーバーラップは行われない。
	* `overlap_angle`において，オーバーラップ幅を角度(˚)を実数で設定する。
	* `projector_tone_curve`において，プロジェクタの階調特性の測定値を設定する。
		* `input`には，0から255のグレーのデジタル値を記述する。
		* `output`には，`input`値のグレー画像投影時のプロジェクタ出力値を記述する。この値は，照度に比例した値とする。
		* 0 と 255 の`input`値に対応する，`output`値はそれぞれ 0 と 255 となるように適当に正規化する。
		* `input`と`output`の要素数は等しいこと。

overlap_setting.json の例:

```
{
    "overlap_angle": 5,
    "projector_tone_curve": {
        "input": [0, 32, 64, 96, 128, 160, 192, 224, 255],
        "output": [0, 1.468, 3.769, 11.74, 29.33, 56.27, 88.30, 140.4, 255]
    }
}
```

* オーバーラップを行うと，`screen_#.png`緑レイヤーで設定された各スクリーンの左右のエッジの前後の画像にグラデーションがかかる。したがって，プロジェクタが実際に出力する範囲は，`screen_#.png`緑レイヤーで設定したスクリーンサイズよりも，overlap_angle / 2の分だけ左右に伸びることになる。


* 課題：プロジェクタごとの個別設定，あるいは自動設定の対応。例えば，screen_#.pngからオーバーラップ領域を自動認識するなど。



### 3. 測定
*	Wireless LAN connection with THETA


Mapping spherical image
-----------------------


